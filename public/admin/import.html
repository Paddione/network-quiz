<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Import - Netzwerk-Quiz</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        .admin-container {
            display: flex;
            min-height: calc(100vh - 50px);
        }

        .sidebar {
            width: 250px;
            background: #2c3e50;
            color: white;
            padding: 20px 0;
        }

        .sidebar h3 {
            padding: 0 20px;
            margin-bottom: 20px;
            color: white;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
        }

        .sidebar li {
            padding: 10px 20px;
            border-left: 3px solid transparent;
        }

        .sidebar li.active {
            background: #34495e;
            border-left-color: var(--primary-color);
        }

        .sidebar a {
            color: white;
            text-decoration: none;
            display: block;
        }

        .content {
            flex: 1;
            padding: 20px;
            background: #f5f7fa;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .import-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        textarea {
            width: 100%;
            height: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            margin-bottom: 20px;
        }

        .import-options {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .error-message, .success-message {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message {
            background-color: #f8d7da;
            color: var(--wrong-color);
        }

        .success-message {
            background-color: #d4edda;
            color: var(--correct-color);
        }

        .user-info {
            margin-bottom: 20px;
            text-align: right;
        }

        .btn-logout {
            background-color: #e74c3c;
        }

        .btn-logout:hover {
            background-color: #c0392b;
        }
    </style>
</head>
<body>
<div class="admin-container">
    <div class="sidebar">
        <h3>Admin Panel</h3>
        <ul>
            <li><a href="/admin">Dashboard</a></li>
            <li><a href="/admin/quizzes">Quiz-Sets</a></li>
            <li><a href="/admin/quiz-editor">Quiz-Editor</a></li>
            <li class="active"><a href="/admin/import">Import</a></li>
            <li><a href="/admin/users">Benutzer</a></li>
            <li><a href="/profile">Mein Profil</a></li>
            <li><a href="/logout">Abmelden</a></li>
        </ul>
    </div>

    <div class="content">
        <div class="dashboard-header">
            <h2>Quiz-Daten importieren</h2>
            <div class="user-info">
                <span id="username">Admin</span>
                <a href="/logout" class="btn btn-logout">Abmelden</a>
            </div>
        </div>

        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>

        <div class="import-section">
            <h3>JSON-Daten importieren</h3>
            <p>Hier kannst du Quiz-Daten im JSON-Format importieren. Die Daten müssen der folgenden Struktur entsprechen:</p>

            <pre><code>{
  "title": "Quiz-Titel",
  "description": "Beschreibung des Quiz",
  "chapters": [
    {
      "title": "Kapitel-Titel",
      "questions": [
        {
          "question": "Frage-Text",
          "type": "multiple",
          "options": ["Option 1", "Option 2", "Option 3", "Option 4"],
          "correct": 0,
          "explanation": "Erklärung zur Antwort"
        }
      ]
    }
  ]
}</code></pre>

            <div class="form-group">
                <label for="quizTitle">Quiz-Titel</label>
                <input type="text" id="quizTitle" placeholder="Titel des neuen Quiz-Sets" required>
            </div>

            <div class="form-group">
                <label for="quizDescription">Beschreibung (optional)</label>
                <input type="text" id="quizDescription" placeholder="Kurze Beschreibung des Quiz-Sets">
            </div>

            <div class="form-group">
                <label for="importData">JSON-Daten</label>
                <textarea id="importData" placeholder="Füge hier die JSON-Daten ein"></textarea>
            </div>

            <div class="import-options">
                <div>
                    <button id="importBtn" class="btn">Importieren</button>
                    <button id="validateBtn" class="btn">Validieren</button>
                </div>
                <div>
                    <select id="importMode">
                        <option value="create">Neues Quiz-Set erstellen</option>
                        <option value="append">Zu bestehendem Quiz-Set hinzufügen</option>
                    </select>
                    <div id="quizSetSelection" style="display:none; margin-top: 10px;">
                        <label for="existingQuizSet">Bestehendes Quiz-Set</label>
                        <select id="existingQuizSet">
                            <option value="">Lade Quizzes...</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="import-section">
            <h3>Beispiel-Format</h3>
            <p>Hier ist ein einfaches Beispiel, das du kopieren und anpassen kannst:</p>

            <pre><code>{
  "title": "Netzwerk-Grundlagen",
  "description": "Ein Quiz über Grundlagen moderner Computernetze",
  "chapters": [
    {
      "title": "Kapitel 1: Einführung",
      "questions": [
        {
          "question": "Was bedeutet der Begriff 'Informationsgesellschaft'?",
          "type": "multiple",
          "options": [
            "Eine Gesellschaft, die ausschließlich digital kommuniziert",
            "Eine Gesellschaft, in der Informationstechnologien eine zentrale Rolle spielen",
            "Eine Gesellschaft ohne analoge Medien",
            "Eine Gesellschaft, die nur aus IT-Experten besteht"
          ],
          "correct": 1,
          "explanation": "Die Informationsgesellschaft ist geprägt durch den umfassenden Einsatz von Informations- und Kommunikationstechnologien in allen Lebensbereichen."
        }
      ]
    }
  ]
}</code></pre>
        </div>
    </div>
</div>

<script>
    // DOM elements
    const importModeSelect = document.getElementById('importMode');
    const quizSetSelection = document.getElementById('quizSetSelection');
    const existingQuizSetSelect = document.getElementById('existingQuizSet');
    const importBtn = document.getElementById('importBtn');
    const validateBtn = document.getElementById('validateBtn');
    const importDataTextarea = document.getElementById('importData');
    const quizTitleInput = document.getElementById('quizTitle');
    const quizDescriptionInput = document.getElementById('quizDescription');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');

    // Check if user is authenticated as admin
    async function checkAuth() {
        try {
            const response = await fetch('/api/check-auth');
            const data = await response.json();

            if (!data.authenticated || !data.isAdmin) {
                window.location.href = '/login?error=access_denied';
                return false;
            }

            document.getElementById('username').textContent = data.username;
            return true;
        } catch (error) {
            console.error('Auth check error:', error);
            window.location.href = '/login?error=access_denied';
            return false;
        }
    }

    // Load quiz sets
    async function loadQuizSets() {
        try {
            const response = await fetch('/admin/api/quiz-sets');
            const quizSets = await response.json();

            existingQuizSetSelect.innerHTML = '';

            if (quizSets.length > 0) {
                quizSets.forEach(quizSet => {
                    const option = document.createElement('option');
                    option.value = quizSet.id;
                    option.textContent = quizSet.title;
                    existingQuizSetSelect.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Keine Quiz-Sets verfügbar';
                existingQuizSetSelect.appendChild(option);
            }
        } catch (error) {
            console.error('Quiz sets fetch error:', error);
        }
    }

    // Validate JSON data
    function validateQuizData(jsonData) {
        if (!jsonData) {
            return { valid: false, error: 'Keine Daten vorhanden.' };
        }

        // Check if required fields exist
        if (!jsonData.chapters || !Array.isArray(jsonData.chapters)) {
            return { valid: false, error: 'Das Format ist ungültig. "chapters" fehlt oder ist kein Array.' };
        }

        // Check if each chapter has questions
        for (let i = 0; i < jsonData.chapters.length; i++) {
            const chapter = jsonData.chapters[i];

            if (!chapter.title) {
                return { valid: false, error: `Kapitel ${i + 1} hat keinen Titel.` };
            }

            if (!chapter.questions || !Array.isArray(chapter.questions)) {
                return { valid: false, error: `Kapitel "${chapter.title}" hat keine Fragen oder "questions" ist kein Array.` };
            }

            // Check if each question has required fields
            for (let j = 0; j < chapter.questions.length; j++) {
                const question = chapter.questions[j];

                if (!question.question) {
                    return { valid: false, error: `Frage ${j + 1} in Kapitel "${chapter.title}" hat keinen Fragetext.` };
                }

                if (!question.options || !Array.isArray(question.options) || question.options.length < 2) {
                    return { valid: false, error: `Frage "${question.question}" in Kapitel "${chapter.title}" hat keine oder zu wenige Optionen.` };
                }

                if (typeof question.correct !== 'number' || question.correct < 0 || question.correct >= question.options.length) {
                    return { valid: false, error: `Frage "${question.question}" in Kapitel "${chapter.title}" hat keine gültige korrekte Antwort.` };
                }
            }
        }

        return { valid: true };
    }

    // Import quiz data
    async function importQuizData() {
        errorMessage.style.display = 'none';
        successMessage.style.display = 'none';

        // Get import data
        let jsonData;
        try {
            jsonData = JSON.parse(importDataTextarea.value);
        } catch (error) {
            errorMessage.textContent = 'Ungültiges JSON-Format: ' + error.message;
            errorMessage.style.display = 'block';
            return;
        }

        // Validate data
        const validation = validateQuizData(jsonData);
        if (!validation.valid) {
            errorMessage.textContent = validation.error;
            errorMessage.style.display = 'block';
            return;
        }

        // Get import mode
        const mode = importModeSelect.value;

        if (mode === 'create') {
            // Check if title is provided
            if (!quizTitleInput.value.trim()) {
                errorMessage.textContent = 'Bitte gib einen Titel für das Quiz-Set ein.';
                errorMessage.style.display = 'block';
                return;
            }

            // Create new quiz set
            jsonData.title = quizTitleInput.value.trim();
            jsonData.description = quizDescriptionInput.value.trim();
        } else if (mode === 'append') {
            // Check if quiz set is selected
            if (!existingQuizSetSelect.value) {
                errorMessage.textContent = 'Bitte wähle ein bestehendes Quiz-Set aus.';
                errorMessage.style.display = 'block';
                return;
            }

            // Get selected quiz set
            const quizSetId = existingQuizSetSelect.value;

            // TODO: Implement append functionality
            // For now, just create a new quiz set

            // Create new quiz set
            jsonData.title = quizTitleInput.value.trim();
            jsonData.description = quizDescriptionInput.value.trim();
        }

        try {
            // Send data to server
            const response = await fetch('/admin/api/import', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ quizData: jsonData })
            });

            const result = await response.json();

            if (result.error) {
                errorMessage.textContent = result.error;
                errorMessage.style.display = 'block';
            } else {
                successMessage.textContent = result.message || 'Quiz-Daten erfolgreich importiert!';
                successMessage.style.display = 'block';

                // Clear form
                importDataTextarea.value = '';
                quizTitleInput.value = '';
                quizDescriptionInput.value = '';
            }
        } catch (error) {
            console.error('Import error:', error);
            errorMessage.textContent = 'Ein Fehler ist beim Import aufgetreten.';
            errorMessage.style.display = 'block';
        }
    }

    // Validate quiz data only
    function validateOnly() {
        errorMessage.style.display = 'none';
        successMessage.style.display = 'none';

        // Get import data
        let jsonData;
        try {
            jsonData = JSON.parse(importDataTextarea.value);
        } catch (error) {
            errorMessage.textContent = 'Ungültiges JSON-Format: ' + error.message;
            errorMessage.style.display = 'block';
            return;
        }

        // Validate data
        const validation = validateQuizData(jsonData);
        if (!validation.valid) {
            errorMessage.textContent = validation.error;
            errorMessage.style.display = 'block';
        } else {
            successMessage.textContent = 'Die Daten sind gültig! ' +
                jsonData.chapters.length + ' Kapitel mit insgesamt ' +
                jsonData.chapters.reduce((total, chapter) => total + chapter.questions.length, 0) + ' Fragen.';
            successMessage.style.display = 'block';
        }
    }

    // Event listeners
    importModeSelect.addEventListener('change', function() {
        if (this.value === 'append') {
            quizSetSelection.style.display = 'block';
        } else {
            quizSetSelection.style.display = 'none';
        }
    });

    importBtn.addEventListener('click', importQuizData);
    validateBtn.addEventListener('click', validateOnly);

    // Initialize page
    async function init() {
        const isAuthorized = await checkAuth();

        if (isAuthorized) {
            await loadQuizSets();
        }
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>